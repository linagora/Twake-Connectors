<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="{{ onlyoffice_server }}/web-apps/apps/api/documents/api.js"></script>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no,shrink-to-fit=no">
</head>
<body style="height:100%">

<div id="onlyoffice_container"
     style="top:0; left: 0;width: 100%;height: 100%;position: absolute;color: #FFF;text-align: center;background-color: #{{ color }}">
</div>

<script type="text/javascript">

    window.workspaceId = "{{ workspaceId }}";
    window.user = {
        id: "{{ userid }}",
        username: "{{ username|capitalize }}",
        language: "{{ language }}",
        userimage: "{{ userimage }}"
    };

    window.mode = "{{ mode }}";
    defaultExtension = "{{ defaultExtension }}";

    var allowedextensions = [];

    if (window.mode == "text") {
        allowedextensions = ["docx", "doc", "docm", "dot", "dotm", "dotx", "epub", "fodt", "mht", "odt", "pdf", "rtf", "txt", "djvu", "xps"];
    }
    if (window.mode == "presentation") {
        allowedextensions = ["pptx", "fodp", "odp", "pot", "potm", "potx", "pps", "ppsm", "ppsx", "ppt", "pptm"];
    }
    if (window.mode == "spreadsheet") {
        allowedextensions = ["xlsx", "csv", "fods", "ods", "xls", "xlsm", "xlt", "xltm", "xltx"];
    }

    window.baseURL = "{{ server }}r7_office/" + window.mode + "/";

    openFile = function (doc) {

        var scrollSensitivity = 100;
        if (mode != "text") {
            scrollSensitivity = 40;
        }

        document.querySelector("#onlyoffice_container").innerHTML = "<div id='onlyoffice_container_instance'></div>";

        console.log(window.baseURL + "save?token=" + doc.token);

        window.docEditor = new DocsAPI.DocEditor("onlyoffice_container_instance",
            {
                scrollSensitivity: scrollSensitivity,
                width: "100%",
                height: "100%",
                documentType: mode,
                document: doc,
                token: doc.token,
                type: (screen.width < 600) ? 'mobile' : 'desktop',
                editorConfig: {
                    callbackUrl: window.baseURL + "save?fileId="+doc.file_id+"&token=" + doc.token +"&groupId=" + "{{ groupid }}",
                    "lang": window.user.language,
                    "user": {
                        "id": window.user.id,
                        "name": window.user.username
                    },
                    customization: {
                        chat: false,
                        compactToolbar: true,
                        about: false,
                        feedback: false,
                        goback: {
                            text: "",
                            blank: false,
                            url: "#"
                        }
                    }
                },
                events: {
                    'onReady': function () {
                    },
                    'onDocumentStateChange': function () {
                    },
                    'onRequestEditRights': function () {
                    },
                    'onError': function () {
                    },
                    'onOutdatedVersion': function () {
                    }
                }
            });
    };

    fetch(window.baseURL + "open", {
        body: JSON.stringify({
            "file_id": "{{ file_id }}",
            "filename": "{{ filename }}",
            "workspaceId": "{{ workspaceId }}",
            "user_id" : "{{ userid }}",
            "groupId" : "{{ groupid }}"
        }),
        method: 'POST',
    }).then(response => response.json())
    .then(data => function (data) {

        var doc = {
            title: data.filename,
            url: window.baseURL + "read?fileToken="+data.token+"&fileId="+data.file_id+"&groupId="+"{{ groupid }}",
            fileType: "{{ fileType }}",
            key: data.key,
            token: data.token,
            file_id: "{{ file_id }}",
            permissions: {
                download: true,
                edit: !{{ preview }},
                review: !{{ preview }}
            }
        };
        console.log("read : " +doc.url);

        openFile(doc);
    });
</script>

</body>
</html>

